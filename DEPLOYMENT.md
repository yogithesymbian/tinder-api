# Deployment Guide for Render.com

This guide will help you deploy the Tinder API Laravel application with PostgreSQL on Render.com's free tier.

## Prerequisites

- A GitHub account
- A Render.com account (free tier available at https://render.com)
- This repository pushed to GitHub

## Deployment Steps

### Option 1: Using Render Blueprint (Recommended - Easiest)

1. **Push this repository to GitHub** (if not already done)

2. **Go to Render Dashboard**
   - Visit https://dashboard.render.com
   - Sign in or create a free account

3. **Create New Blueprint**
   - Click "New" → "Blueprint"
   - Connect your GitHub account if not already connected
   - Select this repository (`yogithesymbian/tinder-api`)
   - Render will automatically detect the `render.yaml` file

4. **Deploy**
   - Click "Apply" to create all services defined in `render.yaml`
   - Render will create:
     - PostgreSQL database (free tier)
     - Web service for the Laravel application (free tier)
   - Wait for the deployment to complete (first deployment may take 5-10 minutes)

5. **Access Your Application**
   - Once deployed, you'll get a URL like: `https://tinder-api.onrender.com`
   - API Documentation will be available at: `https://tinder-api.onrender.com/api/documentation`

### Option 2: Manual Setup

If you prefer to set up services manually:

#### Step 1: Create PostgreSQL Database

1. Go to Render Dashboard → "New" → "PostgreSQL"
2. Configure:
   - **Name**: `tinder-api-db`
   - **Database**: `tinder_db`
   - **User**: `tinder_user`
   - **Region**: Choose closest to you
   - **Plan**: Free
3. Click "Create Database"
4. Note down the connection details (will be used in web service)

#### Step 2: Create Web Service

1. Go to Render Dashboard → "New" → "Web Service"
2. Connect your GitHub repository
3. Configure:
   - **Name**: `tinder-api`
   - **Runtime**: Docker
   - **Plan**: Free
   - **Note**: When using Docker runtime, do NOT specify Build Command or Start Command. These are handled by the Dockerfile.

4. **Add Environment Variables**:
   ```
   APP_ENV=production
   APP_DEBUG=false
   APP_KEY=base64:[generated by Laravel]
   DB_CONNECTION=pgsql
   DB_HOST=[from database internal connection string]
   DB_PORT=5432
   DB_DATABASE=tinder_db
   DB_USERNAME=tinder_user
   DB_PASSWORD=[from database credentials]
   SESSION_DRIVER=database
   CACHE_STORE=database
   QUEUE_CONNECTION=database
   LOG_CHANNEL=stack
   LOG_LEVEL=info
   ```

5. Click "Create Web Service"

## Important Notes

### Free Tier Limitations

- **Web Service**: Spins down after 15 minutes of inactivity (first request after spin-down may take 30-60 seconds)
- **Database**: 
  - 1 GB storage
  - Expires after 90 days (you'll need to backup and recreate)
  - Single database instance
- **Build Time**: Limited to 15 minutes per deploy

### Database Migrations

Migrations run automatically on every deployment via the `render-start.sh` script. The database schema will be created on first deployment.

### Environment Variables

The application is configured to use environment variables from Render. You can update them in the Render Dashboard under your web service → "Environment" tab.

### Monitoring and Logs

- View logs in Render Dashboard → Select your service → "Logs" tab
- Monitor performance and uptime in the "Metrics" tab

### Custom Domain (Optional)

On Render's paid plans, you can add a custom domain:
1. Go to your web service settings
2. Add your custom domain
3. Update DNS records as instructed by Render

## API Endpoints

Once deployed, your API will be available at:

- **Base URL**: `https://your-app-name.onrender.com/api/v1`
- **Swagger Documentation**: `https://your-app-name.onrender.com/api/documentation`

### Available Endpoints

- `POST /api/v1/register` - Register a new user
- `POST /api/v1/login` - Login user
- `POST /api/v1/logout` - Logout user (requires authentication)
- `GET /api/v1/people` - Get list of people (requires authentication)
- `POST /api/v1/people/{id}/like` - Like a person (requires authentication)
- `POST /api/v1/people/{id}/dislike` - Dislike a person (requires authentication)
- `GET /api/v1/people/liked` - Get liked people (requires authentication)

## Testing the Deployment

1. **Check Health**: Visit your app URL - you should see the Laravel welcome page
2. **Check API Docs**: Visit `/api/documentation` for Swagger UI
3. **Test Registration**: Use the Swagger UI to register a test user
4. **Test Login**: Login with the test user credentials
5. **Test Protected Routes**: Use the bearer token from login to access protected endpoints

## Troubleshooting

### Build Fails

- Check build logs in Render Dashboard
- Ensure all dependencies are listed in `composer.json`
- Verify PHP version compatibility (requires PHP 8.2+)

#### "Database file does not exist" Error During Build

If you see an error like:
```
Database file at path [/var/www/html/database/database.sqlite] does not exist
```

This indicates the build script is trying to access the database during build time. This has been fixed in `render-build.sh` by using the array cache driver during build. If you still encounter this:

1. Ensure `render-build.sh` uses `CACHE_STORE=array` for cache operations
2. Database credentials are only available at runtime, not during Docker build
3. The fix sets `CACHE_STORE=array php artisan cache:clear` instead of just `php artisan cache:clear`

### Database Connection Fails

- Verify database credentials in environment variables
- Check database is running and accessible
- Ensure PostgreSQL database is in the same region as web service for best performance

#### "Relation 'cache' does not exist" Error During Startup

If you see an error like:
```
SQLSTATE[42P01]: Undefined table: 7 ERROR:  relation "cache" does not exist
LINE 1: delete from "cache"
```

This has been fixed in `render-start.sh` by:
1. Using `CACHE_STORE=file` for the `cache:clear` command during startup
2. Adding proper error handling so non-critical failures don't stop the deployment
3. Removing `set -e` to allow graceful error handling

The issue occurred because after running migrations, the cache clear command tried to use the database cache driver before the database connection properly recognized the newly created cache table. Using file-based cache for the startup cache clear avoids this issue entirely.

### Application Errors

- Check application logs in Render Dashboard
- Enable debug mode temporarily: Set `APP_DEBUG=true` (remember to disable in production)
- Verify all environment variables are set correctly

### Slow First Request

This is normal on free tier - the service spins down after 15 minutes of inactivity. Consider upgrading to paid plan for always-on service.

## Alternative Free Deployment Platforms

If Render.com doesn't meet your needs, consider:

1. **Railway.app** - Similar to Render, $5 free credit monthly
2. **Fly.io** - Free tier with limitations
3. **Heroku** - Free tier discontinued, but student pack available
4. **DigitalOcean App Platform** - Free tier for static sites, paid for apps
5. **AWS Free Tier** - EC2 + RDS (more complex setup, requires AWS knowledge)

## Support

For issues specific to this deployment:
- Check Render documentation: https://render.com/docs
- Laravel deployment docs: https://laravel.com/docs/deployment
- Open an issue in this repository

## Security Notes

- Never commit `.env` file or expose `APP_KEY`
- Use strong database passwords
- Keep dependencies updated
- Monitor Render's security advisories
- Consider enabling SSL/TLS (automatic on Render)
- Use rate limiting (already configured in routes)

## Updating the Application

To deploy updates:
1. Push changes to your GitHub repository
2. Render will automatically detect changes and redeploy
3. Or manually trigger a deploy from Render Dashboard

Auto-deploy is enabled by default when connecting via GitHub.
